<!DOCTYPE html>
<html><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Rails API-only uygulama ve token authentication Â· muratbastas</title>



<link rel="stylesheet" href="/css/rocinante.css" />



<body>
    <header><h2>
  
    <a href="https://murat.github.io">â€¹ muratbastas</a>
  
</h2>
</header>
    <main>

    <div class="post">
        <div class="title-group">
            <div class="title">
                <h1>Rails API-only uygulama ve token authentication</h1>
            </div>
            <div class="date"><h5>Mar 30, 2017</h5></div>
        </div>
        <article class="content">
            <p>Rails ile sadece API &ndash;<strong>API-only</strong>&ndash; uygulama yazmak istiyorsanÄ±z terminalde <code>rails g proje --api</code> ile projeyi oluÅŸturmalÄ±sÄ±nÄ±z. (bkz: <a href="http://edgeguides.rubyonrails.org/api_app.html" target="_blank">edgeguides</a>)</p>
<p><em>Eminim rails ile uygulama geliÅŸtiren hemen hemen herkes kullanÄ±cÄ± iÅŸlemleri iÃ§in <a href="https://github.com/plataformatec/devise" target="_blank">devise</a> kullanÄ±yordur. Devise daha ben rails ile geliÅŸtirmeye baÅŸlamadan Ã§ok evvel TokenAuthenticatable metoduna sahipmiÅŸ fakat <a href="https://github.com/plataformatec/devise/wiki/How-To:-Simple-Token-Authentication-Example" target="_blank">bu metod kaldÄ±rÄ±lmÄ±ÅŸ.</a></em></p>
<p><em><a href="https://github.com/plataformatec/devise/wiki/How-To:-Simple-Token-Authentication-Example" target="_blank">Bu wiki sayfasÄ±</a>nda
token ile oturum aÃ§mak iÃ§in birkaÃ§ yol verilmiÅŸ. Ama <strong>API-only</strong> uygulamada her denememde CookieStore ve SessionStore hatasÄ± aldÄ±m bu gemler ile. Zaten tÃ¼m Ã¶rnek uygulamalarda ve readme dÃ¶kÃ¼manlarÄ±nda <strong>API-only</strong> deÄŸil <strong><code>ActionController::Base</code></strong> den kullanÄ±lmÄ±ÅŸ. Bir sÃ¼re araÅŸtÄ±rdÄ±ktan sonra kendi tokenlerimi oluÅŸturup uygulamaya koymaya karar verecektim ki <a href="https://github.com/adamniedzielski/tiddle/" target="_blank">tiddle</a> gemini buldum. Tam aklÄ±mda kurduÄŸum gibi Ã§alÄ±ÅŸÄ±yor. Åimdi bu gem ile API uygulamamÄ± nasÄ±l hazÄ±rladÄ±ÄŸÄ±mÄ± anlatacaÄŸÄ±m.</em></p>
<h2 id="api-only-uygulama-oluÅŸturmak">API-only uygulama oluÅŸturmak</h2>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">rails new api-only-app -T -B -d postgresql --api
</code></pre></div><p>Bu komut ile oluÅŸturduÄŸunuz rails uygulamasÄ±nÄ±nda <strong>ApplicationController</strong> <strong><code>ActionController::Base</code></strong> sÄ±nÄ±fÄ±ndan deÄŸil <strong><code>ActionController::API</code></strong> sÄ±nÄ±fÄ±ndan extend edilmiÅŸ olacak ve iÃ§inde csrf_token kontrolÃ¼ yapan <code>protect_from_forgery with: :exception</code> ÅŸeklindeki middleware olmayacak. <code>assets</code> dizini hiÃ§ olmayacak.
<code>config/application.rb</code> iÃ§inde <code>config.api_only = true</code> ÅŸeklinde bir set gÃ¶receksiniz. <code>Gemfile</code> iÃ§inde sass, coffee, uglifier, jquery vb assetler ile alakalÄ± hiÃ§ bir gem olmayacak.</p>
<p>Ã–ncelikle gerekli gemleri kuralÄ±m. API uygulamanÄ±za farklÄ± domainlerden eriÅŸim olacak ise rack-cors kuracaÄŸÄ±z. Authentication iÃ§in devise + tiddle kullanacaÄŸÄ±z. HazÄ±rsak baÅŸlayayÄ±m.
Gemfile'Ä± aÅŸaÄŸÄ±daki gibi dÃ¼zenleyelim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh"><span style="color:#75715e"># Gemfile</span>
gem <span style="color:#d88200">&#39;rack-cors&#39;</span>, :require <span style="color:#f92672">=</span>&gt; <span style="color:#d88200">&#39;rack/cors&#39;</span>

gem <span style="color:#d88200">&#39;devise&#39;</span>
gem <span style="color:#d88200">&#39;tiddle&#39;</span>
</code></pre></div><p>Ve ÅŸimdi <code>bundle install</code>.</p>
<p>Gemler kurulduktan sonra&hellip;</p>
<h3 id="corsu-ayarlayalÄ±m">Cors&rsquo;u ayarlayalÄ±m</h3>
<p><code>config/initializers/cors.rb</code> adÄ±nda bir initializer oluÅŸturup iÃ§eriÄŸini aÅŸaÄŸÄ±daki ÅŸekilde dÃ¼zenleyelim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">Rails.application.config.middleware.insert_before 0, Rack::Cors <span style="color:#00a8c8">do</span>
  allow <span style="color:#00a8c8">do</span>
    origins <span style="color:#d88200">&#39;*&#39;</span>

    resource <span style="color:#d88200">&#39;*&#39;</span>,
      headers: :any,
      expose: <span style="color:#f92672">[</span><span style="color:#d88200">&#39;X-USER-TOKEN&#39;</span>, <span style="color:#d88200">&#39;X-USER-EMAIL&#39;</span><span style="color:#f92672">]</span>,
      methods: <span style="color:#f92672">[</span>:get, :post, :put, :delete, :options<span style="color:#f92672">]</span>
  end
end
</code></pre></div><p>Bu kadar.. ğŸ˜Š</p>
<h3 id="deviseÄ±-hazÄ±rlayalÄ±m">Devise'Ä± hazÄ±rlayalÄ±m</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">rails g devise:install
rails g devise User
</code></pre></div><p>API-only uygulamada tÃ¼m requestlerin sonucu json dÃ¶neceÄŸi iÃ§in devise'Ä± aÅŸaÄŸÄ±daki ÅŸekilde yapÄ±landÄ±rmalÄ±yÄ±z.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh"><span style="color:#75715e"># config/initializers/devise.rb</span>
Devise.setup <span style="color:#00a8c8">do</span> <span style="color:#111">|</span>config<span style="color:#111">|</span>
    config.navigational_formats <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span>
end
</code></pre></div><p><strong>Ã–nemli</strong>: BazÄ± kaynaklarda <code>config.navigational_formats: [:json]</code> tanÄ±mlanÄ±yor. Ama boÅŸ array olarak tanÄ±mlanmazsa flash message hatalarÄ± alÄ±yoruz</p>
<p>TokenAuthenticatable iÃ§in <code>user.rb</code> modeline aÅŸaÄŸÄ±daki gibi <code>:token_authenticatable</code> ekleyelim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">class User &lt; ActiveRecord::Base
  devise :database_authenticatable, :registerable,
         :recoverable, :trackable, :validatable,
         :token_authenticatable
  <span style="color:#75715e"># ...</span>
end
</code></pre></div><p>Tiddle iÃ§in <strong>AuthenticationToken</strong> modelini oluÅŸturalÄ±m.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">rails g model AuthenticationToken body:string user:references last_used_at:datetime ip_address:string user_agent:string
</code></pre></div><p>Ve ÅŸimdi <code>rake db:migrate</code>.</p>
<h3 id="bir-model-oluÅŸturalÄ±m">Bir model oluÅŸturalÄ±m</h3>
<p>Ã–rnek iÃ§in scaffold Ã¼zerinden ilerleyeceÄŸim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">rails g scaffold post title:string body:text --api
</code></pre></div><p>Ve ÅŸimdi <code>rake db:migrate</code>.</p>
<h3 id="controller-dosyalarÄ±nÄ±-dÃ¼zenleyelim">Controller dosyalarÄ±nÄ± dÃ¼zenleyelim</h3>
<p>Scaffold ile oluÅŸturduÄŸumuz controller dosyasÄ±nÄ± <strong>controllers/api/v1</strong> iÃ§ine taÅŸÄ±yalÄ±m.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">mv app/controllers/posts_controller.rb app/controllers/api/v1/posts_controller.rb
</code></pre></div><p>TaÅŸÄ±dÄ±ktan sonra controller adÄ±nÄ± da aÅŸaÄŸÄ±daki gibi deÄŸiÅŸtirmeyi unutmayalÄ±m ve before_action callback ayarlayarak create, update, destroy metodlarÄ±n koruyalÄ±m.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">class Api::V1::PostsController &lt; ApplicationController
    before_action :authenticate_user!, only: <span style="color:#f92672">[</span>:create, :update, :destroy<span style="color:#f92672">]</span>
    <span style="color:#75715e"># ...</span>
end
</code></pre></div><p>Devise metodlarÄ±nÄ±n Ã¼zerine yazmak iÃ§in <strong>api/auth</strong> iÃ§inde <code>sessions_controller.rb</code> ve <code>registrations_controller.rb</code> dosyalarÄ±nÄ± oluÅŸturalÄ±m.</p>
<p>SessionsController da create metodunun Ã¼zerine yazarak authenticate den sonra bir token oluÅŸturup dÃ¶ndÃ¼relim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh"><span style="color:#75715e"># sessions_controller.rb</span>

class Api::Auth::SessionsController &lt; Devise::SessionsController

  def create
    <span style="color:#111">user</span> <span style="color:#f92672">=</span> warden.authenticate!<span style="color:#f92672">(</span>auth_options<span style="color:#f92672">)</span>
    <span style="color:#111">token</span> <span style="color:#f92672">=</span> Tiddle.create_and_return_token<span style="color:#f92672">(</span>user, request<span style="color:#f92672">)</span>
    render json: <span style="color:#f92672">{</span> authentication_token: token <span style="color:#f92672">}</span>
  end

  def destroy
    Tiddle.expire_token<span style="color:#f92672">(</span>current_user, request<span style="color:#f92672">)</span> <span style="color:#00a8c8">if</span> current_user
    render json: <span style="color:#f92672">{}</span>
  end

  private

    <span style="color:#75715e"># bu metod before_destroy callback i olarak Ã§alÄ±ÅŸÄ±yor. biz bunun Ã¼zerine yazÄ±yoruz.</span>
    def verify_signed_out_user
    end

end
</code></pre></div><p>RegistrationsController da flash mesajlarÄ± yok edelim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh"><span style="color:#75715e"># registrations_controller.rb</span>

class Api::Auth::RegistrationsController &lt; Devise::RegistrationsController

  def create
    build_resource<span style="color:#f92672">(</span>sign_up_params<span style="color:#f92672">)</span>

    resource.save
    yield resource <span style="color:#00a8c8">if</span> block_given?
    <span style="color:#00a8c8">if</span> resource.persisted?
      <span style="color:#00a8c8">if</span> resource.active_for_authentication?
        <span style="color:#75715e"># set_flash_message! :notice, :signed_up if is_navigational_format?</span>
        sign_up<span style="color:#f92672">(</span>resource_name, resource<span style="color:#f92672">)</span>
        <span style="color:#00a8c8">return</span> render :json <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>:success <span style="color:#f92672">=</span>&gt; true, :data <span style="color:#f92672">=</span>&gt; resource<span style="color:#f92672">}</span>
      <span style="color:#00a8c8">else</span>
        <span style="color:#75715e"># set_flash_message! :notice, :&#34;signed_up_but_#{resource.inactive_message}&#34; if is_navigational_format?</span>
        expire_data_after_sign_in!
        <span style="color:#00a8c8">return</span> render :json <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>:success <span style="color:#f92672">=</span>&gt; true, :data <span style="color:#f92672">=</span>&gt; resource<span style="color:#f92672">}</span>
      end
    <span style="color:#00a8c8">else</span>
      clean_up_passwords resource
      <span style="color:#00a8c8">return</span> render :json <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span>:success <span style="color:#f92672">=</span>&gt; false, :error <span style="color:#f92672">=</span>&gt; resource.errors<span style="color:#f92672">}</span>
    end
  end

end
</code></pre></div><h3 id="rotalarÄ±mÄ±zÄ±-ayarlayalÄ±m">RotalarÄ±mÄ±zÄ± ayarlayalÄ±m</h3>
<p>Authentication iÃ§in api/auth ve uygulama rotalarÄ± iÃ§in /api/v1/controller ÅŸeklinde rota kullanacaÄŸÄ±m.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">Rails.application.routes.draw <span style="color:#00a8c8">do</span>

  devise_for :users,
              path: <span style="color:#d88200">&#39;api/auth&#39;</span>,
              defaults: <span style="color:#f92672">{</span> format: :json <span style="color:#f92672">}</span>,
              controllers: <span style="color:#f92672">{</span>
                sessions: <span style="color:#d88200">&#39;api/auth/sessions&#39;</span>,
                registrations: <span style="color:#d88200">&#39;api/auth/registrations&#39;</span>
              <span style="color:#f92672">}</span>

  namespace :api, defaults: <span style="color:#f92672">{</span> format: :json <span style="color:#f92672">}</span> <span style="color:#00a8c8">do</span>
    namespace :v1 <span style="color:#00a8c8">do</span>
      resources :posts
    end
  end

end
</code></pre></div><h3 id="Ã§alÄ±ÅŸtÄ±ralÄ±m">Ã‡alÄ±ÅŸtÄ±ralÄ±m</h3>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh">rails s -p <span style="color:#ae81ff">3000</span>
</code></pre></div><p>En basit haliyle bir API-only uygulama yazmÄ±ÅŸ ve Ã§alÄ±ÅŸtÄ±rmÄ±ÅŸ olduk. Åimdi bu uygulamayÄ± test edelim.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-zsh" data-lang="zsh"><span style="color:#75715e"># kayÄ±t olmak iÃ§in</span>

curl -X POST http://localhost:3000/api/auth --data <span style="color:#d88200">&#39;{user:{email:&#39;</span>yahya@kemal.im<span style="color:#d88200">&#39;,password:&#39;</span>12345678<span style="color:#d88200">&#39;,password_confirmation:&#39;</span>12345678<span style="color:#d88200">&#39;}}&#39;</span>
<span style="color:#75715e"># sonuÃ§</span>
<span style="color:#f92672">{</span>
  <span style="color:#d88200">&#34;success&#34;</span>: true,
  <span style="color:#d88200">&#34;data&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#d88200">&#34;id&#34;</span>: 6,
    <span style="color:#d88200">&#34;email&#34;</span>: <span style="color:#d88200">&#34;yahya@kemal.im&#34;</span>,
    <span style="color:#d88200">&#34;created_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.879Z&#34;</span>,
    <span style="color:#d88200">&#34;updated_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.918Z&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># giriÅŸ yapmak ve token almak iÃ§in</span>

curl -X POST http://localhost:3000/api/auth/sign_in --data <span style="color:#d88200">&#39;{user:{email:&#39;</span>yahya@kemal.im<span style="color:#d88200">&#39;,password:&#39;</span>12345678<span style="color:#d88200">&#39;}}&#39;</span>
<span style="color:#75715e"># sonuÃ§</span>
<span style="color:#f92672">{</span>
  <span style="color:#d88200">&#34;authentication_token&#34;</span>: <span style="color:#d88200">&#34;yYZpAEa3kxid3E6ZLHQp&#34;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># posts#index iÃ§in</span>

curl -X GET http://localhost:3000/api/v1/posts

<span style="color:#75715e"># sonuÃ§</span>
<span style="color:#f92672">{</span>
  <span style="color:#d88200">&#34;success&#34;</span>: true,
  <span style="color:#d88200">&#34;data&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#d88200">&#34;id&#34;</span>: 1,
    <span style="color:#d88200">&#34;title&#34;</span>: <span style="color:#d88200">&#34;Test 1&#34;</span>,
    <span style="color:#d88200">&#34;created_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.879Z&#34;</span>,
    <span style="color:#d88200">&#34;updated_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.918Z&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e"># posts#create iÃ§in</span>

curl -X POST http://localhost:3000/api/v1/posts <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --header <span style="color:#d88200">&#39;x-user-email: yahya@kemal.im&#39;</span> <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --header <span style="color:#d88200">&#39;x-user-token: yYZpAEa3kxid3E6ZLHQp&#39;</span> <span style="color:#8045ff">\
</span><span style="color:#8045ff"></span>  --data <span style="color:#d88200">&#39;{posts:{title:&#34;Test 2&#34;}}&#39;</span>

<span style="color:#75715e"># sonuÃ§</span>
<span style="color:#f92672">{</span>
  <span style="color:#d88200">&#34;success&#34;</span>: true,
  <span style="color:#d88200">&#34;data&#34;</span>: <span style="color:#f92672">{</span>
    <span style="color:#d88200">&#34;id&#34;</span>: 1,
    <span style="color:#d88200">&#34;title&#34;</span>: <span style="color:#d88200">&#34;Test 2&#34;</span>,
    <span style="color:#d88200">&#34;created_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.879Z&#34;</span>,
    <span style="color:#d88200">&#34;updated_at&#34;</span>: <span style="color:#d88200">&#34;2017-03-30T23:13:23.918Z&#34;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Evet diÄŸer korunan requestleri de aynÄ± ÅŸekilde x-user-email ve x-user-token Ã¼st bilgilerini(header) gÃ¶ndererek gÃ¼ncelleyebilirsiniz.</p>
<p>Birilerine faydalÄ± olduÄŸunu umarak, esen kalÄ±n ğŸ™ğŸ»</p>

        </article>
        
    </article>


    </main>
    <footer>
  <div class="content-container">
    <div class="content">Murat Bastas | Software Developer <a href="https://vispera.co" target="_blank">@Vispera</a>.


  <p class="horizontal-links"><a href="/resume.pdf"
       
       
      >Resume</a><a href="/contact"
       
        class="email-hook" id="about-email" title="Click to show email" 
      >Email</a></p>

  <p class="horizontal-links"><a href="https://github.com/murat"
        target="_blank" 
       
      >Github</a><a href="https://twitter.com/muratbastas"
        target="_blank" 
       
      >Twitter</a><a href="https://linkedin.com/in/muratbastas"
        target="_blank" 
       
      >LinkedIn</a></p>

</div>
  </div>
</footer>
    
    <script>
      const emailId = atob("");
    </script>
    <script src="/js/rocinante.min.js"></script>
  </body>
</html>
